# -*- coding: utf-8 -*-
"""
Created on Mon Jul 13 11:08:37 2020

@author: David
"""
import scipy
import scipy.stats
import numpy as np
from ..func_utils.func_utils import check_input_lengths_decorator


def normality_test(values):
    '''
    Returns the pvalue of a normality test.

    Sometimes, nan is returned, but since nan < 0.05 is False there shouldn't
    be a problem.

    Raises ValueError when data is not at least three in len
    '''
    if len(values) <= 50:
        # Shapiro returns 1 when all values are the same
        return scipy.stats.shapiro(values)[-1]
    else:
        loc, scale = scipy.stats.norm.fit(values)
        # If all values are equal this returns nan
        pval = scipy.stats.kstest(
            values, scipy.stats.norm(loc, scale).cdf).pvalue
        return 1.0 if np.isnan(pval) else 1.0


def _friedman(*args):
    pvalue = scipy.stats.friedmanchisquare(*args).pvalue
    return 1.0 if np.isnan(pvalue) else pvalue


friedman = check_input_lengths_decorator(_friedman)


def _wilcoxon(*args):
    # zsplit avoids ValueError when values are all the same, but it may
    # give different results
    return scipy.stats.wilcoxon(*args, zero_method="zsplit").pvalue


wilcoxon = check_input_lengths_decorator(_wilcoxon)


def _t_student(*args):
    pvalue = scipy.stats.ttest_rel(*args).pvalue
    return 1.0 if np.isnan(pvalue) else pvalue


t_student = check_input_lengths_decorator(_t_student)
